<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Witze sortieren & gruppieren</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: white;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .main-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            align-items: start;
        }

        .sidebar {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 20px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }

        .sidebar h2 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1.3rem;
        }

        .group-list {
            list-style: none;
            margin-bottom: 20px;
        }

        .group-item {
            margin-bottom: 8px;
        }

        .group-button {
            width: 100%;
            text-align: left;
            padding: 12px 15px;
            border: 2px solid transparent;
            border-radius: 8px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .group-button:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .group-button.active {
            background: #667eea;
            color: white;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }

        .group-button.all-jokes {
            font-weight: 600;
            background: #28a745;
            color: white;
        }

        .group-button.all-jokes:hover {
            background: #218838;
        }

        .group-button.all-jokes.active {
            background: #1e7e34;
        }

        .group-count {
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .group-button.active .group-count {
            background: rgba(255,255,255,0.3);
        }

        .group-button:not(.active) .group-count {
            background: #6c757d;
            color: white;
        }

        .group-actions {
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .group-item:hover .group-actions {
            opacity: 1;
        }

        .group-action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .group-action-btn:hover {
            background: #dc3545;
            color: white;
        }

        .new-group-section {
            border-top: 1px solid #e9ecef;
            padding-top: 15px;
        }

        .new-group-input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .new-group-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .main-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            min-height: 500px;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .content-title {
            font-size: 1.5rem;
            color: #2c3e50;
            margin: 0;
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .search-container {
            min-width: 200px;
        }

        .search-input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:focus {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .joke-list {
            list-style: none;
            position: relative;
        }

        .joke-item {
            background: white;
            border: 2px solid #f8f9fa;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            position: relative;
            cursor: move;
        }

        .joke-item:hover {
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .joke-item.in-group {
            border-color: #28a745;
            background: #f8fff9;
        }

        .joke-item.selected {
            border-color: #ffc107;
            background: #fffbf0;
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
        }

        .joke-item.dragging {
            opacity: 0.7;
            transform: rotate(3deg) scale(1.02);
            z-index: 1000;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .joke-content {
            padding: 20px;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }

        .joke-checkbox {
            margin-top: 8px;
        }

        .joke-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .drag-handle {
            cursor: grab;
            color: #6c757d;
            font-size: 20px;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            height: 40px;
            background: #f8f9fa;
            border: 2px solid transparent;
        }

        .drag-handle:hover {
            background: #e9ecef;
            color: #667eea;
            transform: scale(1.1);
        }

        .drag-handle:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .drag-handle:active {
            cursor: grabbing;
            transform: scale(0.95);
        }

        .joke-main {
            flex: 1;
            min-width: 0;
        }

        .joke-text {
            margin-bottom: 15px;
            line-height: 1.6;
            cursor: pointer;
            padding: 10px;
            border-radius: 6px;
            transition: all 0.2s;
            border: 2px solid transparent;
            min-height: 40px;
            display: flex;
            align-items: center;
        }

        .joke-text:hover {
            background: #f8f9fa;
            border-color: #e9ecef;
        }

        .joke-text:focus {
            background: #fff3cd;
            border-color: #ffc107;
            outline: none;
        }

        .joke-headline {
            font-weight: 600;
            font-size: 18px;
            color: #2c3e50;
        }

        .joke-fulltext {
            font-size: 16px;
            color: #34495e;
            white-space: pre-wrap;
        }

        .joke-edit-input, .joke-edit-textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #667eea;
            border-radius: 6px;
            font-size: 16px;
            font-family: inherit;
            background: white;
        }

        .joke-edit-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .joke-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .joke-groups-info {
            margin-right: auto;
            font-size: 12px;
            color: #6c757d;
        }

        .group-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .group-tag {
            background: #e9ecef;
            color: #495057;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .group-tag.current {
            background: #28a745;
            color: white;
        }

        .mode-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #6c757d;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .toggle-switch:focus {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }

        .toggle-switch.active {
            background: #667eea;
        }

        .toggle-switch::before {
            content: '';
            position: absolute;
            width: 26px;
            height: 26px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-switch.active::before {
            transform: translateX(30px);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state h3 {
            margin-bottom: 15px;
        }

        .selection-actions {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .selection-actions.active {
            display: flex;
        }

        .selection-info {
            font-weight: 600;
            color: #856404;
        }

        .group-select {
            padding: 8px 12px;
            border: 2px solid #ffc107;
            border-radius: 6px;
            background: white;
            color: #333;
        }

        .import-export {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .import-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            margin: 10px 0;
        }

        .hidden {
            display: none;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .live-region {
            position: absolute;
            left: -10000px;
            width: 1px;
            height: 1px;
            overflow: hidden;
        }

        /* Drag Placeholder */
        .drag-placeholder {
            height: 6px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 3px;
            margin: 10px 0;
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }

        .drag-placeholder.active {
            opacity: 1;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(1.5); }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .joke-item.new {
            animation: slideIn 0.3s ease-out;
        }

        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: static;
                max-height: none;
                margin-bottom: 20px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .content-header {
                flex-direction: column;
                align-items: stretch;
            }

            .toolbar {
                justify-content: center;
            }

            .joke-content {
                padding: 15px;
                gap: 10px;
            }

            .joke-controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <header class="header">
        <h1>🎭 Witze sortieren & gruppieren</h1>
    </header>

    <div class="main-layout">
        <!-- Sidebar für Gruppen -->
        <aside class="sidebar">
            <h2>📂 Gruppen</h2>

            <ul class="group-list" id="group-list">
                <li class="group-item">
                    <button class="group-button all-jokes active" data-group="all" onclick="selectGroup('all')">
                        <span>📋 Alle Witze</span>
                        <span class="group-count" id="all-count">0</span>
                    </button>
                </li>
            </ul>

            <div class="new-group-section">
                <input
                        type="text"
                        class="new-group-input"
                        id="new-group-input"
                        placeholder="Neue Gruppe erstellen..."
                        maxlength="50"
                >
                <button class="btn btn-primary btn-small" style="width: 100%;" onclick="createGroup()">
                    ➕ Gruppe erstellen
                </button>
            </div>
        </aside>

        <!-- Hauptinhalt -->
        <main class="main-content">
            <div class="content-header">
                <h2 class="content-title" id="content-title">Alle Witze</h2>

                <div class="toolbar">
                    <button class="btn btn-primary" id="add-joke-btn" onclick="addNewJoke()">
                        ➕ Neuer Witz
                    </button>

                    <div class="search-container">
                        <input
                                type="text"
                                class="search-input"
                                id="search-input"
                                placeholder="🔍 Witze durchsuchen..."
                                aria-label="Witze durchsuchen"
                        >
                    </div>

                    <div class="import-export">
                        <button class="btn btn-secondary" id="import-btn" onclick="showImportSection()">
                            📥 Import
                        </button>
                        <button class="btn btn-secondary" id="export-btn" onclick="exportData()">
                            📤 Export
                        </button>
                    </div>
                </div>
            </div>

            <!-- Auswahl-Aktionen -->
            <div class="selection-actions" id="selection-actions">
                <div class="selection-info" id="selection-info">0 Witze ausgewählt</div>

                <select class="group-select" id="target-group-select">
                    <option value="">Gruppe auswählen...</option>
                </select>

                <button class="btn btn-success btn-small" onclick="addSelectedToGroup()">
                    ➕ Zu Gruppe hinzufügen
                </button>

                <button class="btn btn-warning btn-small" onclick="removeSelectedFromGroup()" id="remove-from-group-btn" style="display: none;">
                    ➖ Aus Gruppe entfernen
                </button>

                <button class="btn btn-secondary btn-small" onclick="clearSelection()">
                    ✖️ Auswahl aufheben
                </button>
            </div>

            <!-- Import-Sektion -->
            <div id="import-section" class="toolbar hidden" style="flex-direction: column; align-items: stretch;">
                <h3>JSON Import/Export</h3>
                <textarea
                        class="import-textarea"
                        id="import-textarea"
                        placeholder="JSON-Daten hier einfügen..."
                        aria-label="JSON-Daten für Import"
                ></textarea>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                    <button class="btn btn-success" onclick="executeImport()">
                        ✅ Importieren
                    </button>
                    <button class="btn btn-secondary" onclick="hideImportSection()">
                        ❌ Abbrechen
                    </button>
                </div>
            </div>

            <ul class="joke-list" id="joke-list" role="list" aria-label="Liste der Witze">
                <!-- Witze werden hier dynamisch eingefügt -->
            </ul>

            <div class="empty-state" id="empty-state" style="display: none;">
                <h3>Keine Witze vorhanden</h3>
                <p id="empty-message">Füge deinen ersten Witz hinzu!</p>
                <button class="btn btn-primary" onclick="addNewJoke()">
                    ➕ Ersten Witz hinzufügen
                </button>
            </div>
        </main>
    </div>

    <div aria-live="polite" aria-atomic="true" class="live-region" id="live-region"></div>
</div>

<script>
    // Globale Variablen
    let jokes = [];
    let groups = {};
    let currentGroup = 'all';
    let selectedJokes = new Set();
    let draggedElement = null;
    let dragPlaceholder = null;
    let searchTerm = '';
    let nextId = 1;

    // Debounce Utility
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Storage Funktionen (in-memory für Claude.ai)
    function saveData() {
        console.log('Daten gespeichert:', {
            jokes: jokes.length,
            groups: Object.keys(groups).length
        });
    }

    function loadData() {
        if (jokes.length === 0) {
            jokes = [
                {
                    id: `w${nextId++}`,
                    headline: "Warum ging das Huhn über die Straße?",
                    fullText: "Um auf die andere Seite zu kommen.",
                    mode: "headline"
                },
                {
                    id: `w${nextId++}`,
                    headline: "Treffen sich zwei Jäger...",
                    fullText: "Treffen sich zwei Jäger im Wald.\nBeide tot.",
                    mode: "full"
                },
                {
                    id: `w${nextId++}`,
                    headline: "Was ist grün und klopft an der Tür?",
                    fullText: "Ein Klopfsalat!",
                    mode: "headline"
                },
                {
                    id: `w${nextId++}`,
                    headline: "Wie nennt man einen Bären ohne Zähne?",
                    fullText: "Haribo!",
                    mode: "headline"
                },
                {
                    id: `w${nextId++}`,
                    headline: "Was ist schwarz-weiß und hüpft?",
                    fullText: "Ein Springpinguin!",
                    mode: "headline"
                }
            ];

            groups = {

                '5 Minuten': {
                    name: '5 Minuten',
                    jokes: [],
                    created: new Date().toISOString()
                },
                '7 Minuten': {
                    name: '7 Minuten',
                    jokes: [],
                    created: new Date().toISOString()
                },
                '8 Minuten': {
                    name: '8 Minuten',
                    jokes: [],
                    created: new Date().toISOString()
                },

                '10 Minuten': {
                    name: '10 Minuten',
                    jokes: [],
                    created: new Date().toISOString()
                },

                '12 Minuten': {
                    name: '12 Minuten',
                    jokes: [],
                    created: new Date().toISOString()
                },

                '15 Minuten': {
                    name: '15 Minuten',
                    jokes: [],
                    created: new Date().toISOString()
                },

                '20 Minuten': {
                    name: '20 Minuten',
                    jokes: [],
                    created: new Date().toISOString()
                },

                '30 Minuten': {
                    name: '30 Minuten',
                    jokes: [],
                    created: new Date().toISOString()
                },


                'Halbsolo': {
                    name: 'Halbsolo',
                    jokes: [],
                    created: new Date().toISOString()
                },


                'Solo': {
                    name: 'Solo',
                    jokes: [],
                    created: new Date().toISOString()
                },

                'One Liner': {
                    name: 'One Liner',
                    jokes: [],
                    created: new Date().toISOString()
                }
            };
        }
    }

    const debouncedSave = debounce(saveData, 300);

    function announceToScreenReader(message) {
        const liveRegion = document.getElementById('live-region');
        liveRegion.textContent = message;
        setTimeout(() => {
            liveRegion.textContent = '';
        }, 1000);
    }

    // Gruppen-Management
    function createGroup() {
        const input = document.getElementById('new-group-input');
        const name = input.value.trim();

        if (!name) {
            alert('Bitte einen Gruppennamen eingeben!');
            return;
        }

        if (Object.values(groups).some(g => g.name.toLowerCase() === name.toLowerCase())) {
            alert('Eine Gruppe mit diesem Namen existiert bereits!');
            return;
        }

        const groupId = 'group_' + Date.now();
        groups[groupId] = {
            name: name,
            jokes: [],
            created: new Date().toISOString()
        };

        input.value = '';
        debouncedSave();
        renderGroups();
        announceToScreenReader(`Gruppe "${name}" erstellt`);
    }

    function deleteGroup(groupId) {
        const group = groups[groupId];
        if (!group) return;

        if (confirm(`Gruppe "${group.name}" wirklich löschen?\nDie Witze bleiben in der Hauptliste erhalten.`)) {
            delete groups[groupId];

            if (currentGroup === groupId) {
                selectGroup('all');
            }

            debouncedSave();
            renderGroups();
            updateTargetGroupSelect();
            announceToScreenReader(`Gruppe "${group.name}" gelöscht`);
        }
    }

    function selectGroup(groupId) {
        currentGroup = groupId;
        clearSelection();

        // UI Update
        document.querySelectorAll('.group-button').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-group="${groupId}"]`).classList.add('active');

        // Title Update
        const title = document.getElementById('content-title');
        if (groupId === 'all') {
            title.textContent = 'Alle Witze';
        } else {
            title.textContent = groups[groupId]?.name || 'Unbekannte Gruppe';
        }

        // Remove-Button Update
        const removeBtn = document.getElementById('remove-from-group-btn');
        removeBtn.style.display = groupId !== 'all' ? 'inline-flex' : 'none';

        renderJokes();
        announceToScreenReader(`Gruppe gewechselt zu: ${title.textContent}`);
    }

    function renderGroups() {
        const groupList = document.getElementById('group-list');
        const allButton = groupList.querySelector('.all-jokes');

        // Alle Gruppen-Buttons außer "Alle Witze" entfernen
        groupList.querySelectorAll('.group-item:not(:first-child)').forEach(item => item.remove());

        // Neue Gruppen hinzufügen
        Object.entries(groups).forEach(([groupId, group]) => {
            const li = document.createElement('li');
            li.className = 'group-item';
            li.innerHTML = `
                <button class="group-button" data-group="${groupId}" onclick="selectGroup('${groupId}')">
                    <span>📁 ${escapeHtml(group.name)}</span>
                    <span class="group-count">${group.jokes.length}</span>
                </button>
                <div class="group-actions">
                    <button class="group-action-btn" onclick="deleteGroup('${groupId}')" title="Gruppe löschen">
                        🗑️
                    </button>
                </div>
            `;
            groupList.appendChild(li);
        });

        updateGroupCounts();
    }

    function updateGroupCounts() {
        // Alle Witze zählen
        document.getElementById('all-count').textContent = jokes.length;

        // Gruppenzählungen aktualisieren
        Object.entries(groups).forEach(([groupId, group]) => {
            const countEl = document.querySelector(`[data-group="${groupId}"] .group-count`);
            if (countEl) {
                countEl.textContent = group.jokes.length;
            }
        });
    }

    function updateTargetGroupSelect() {
        const select = document.getElementById('target-group-select');
        const currentValue = select.value;

        select.innerHTML = '<option value="">Gruppe auswählen...</option>';

        Object.entries(groups).forEach(([groupId, group]) => {
            const option = document.createElement('option');
            option.value = groupId;
            option.textContent = group.name;
            select.appendChild(option);
        });

        if (currentValue && groups[currentValue]) {
            select.value = currentValue;
        }
    }

    // Witz-Management
    function addNewJoke() {
        const newJoke = {
            id: `w${nextId++}`,
            headline: 'Neuer Witz',
            fullText: 'Hier steht der ausgeschriebene Witz...',
            mode: 'headline'
        };
        jokes.unshift(newJoke);
        debouncedSave();
        renderJokes();
        renderGroups();
        announceToScreenReader('Neuer Witz hinzugefügt');

        setTimeout(() => {
            const newElement = document.querySelector(`.joke-item[data-id="${newJoke.id}"]`);
            if (newElement) {
                newElement.querySelector('.joke-text').focus();
            }
        }, 100);
    }

    function deleteJoke(id) {
        if (confirm('Witz wirklich löschen?\nEr wird auch aus allen Gruppen entfernt.')) {
            // Aus Hauptliste entfernen
            jokes = jokes.filter(joke => joke.id !== id);

            // Aus allen Gruppen entfernen
            Object.values(groups).forEach(group => {
                group.jokes = group.jokes.filter(jokeId => jokeId !== id);
            });

            // Aus Auswahl entfernen
            selectedJokes.delete(id);

            debouncedSave();
            renderJokes();
            renderGroups();
            updateSelectionUI();
            announceToScreenReader('Witz gelöscht');
        }
    }

    function toggleJokeMode(id) {
        const joke = jokes.find(j => j.id === id);
        if (joke) {
            joke.mode = joke.mode === 'headline' ? 'full' : 'headline';
            debouncedSave();
            renderJokes();
            announceToScreenReader(`Witz wird nun als ${joke.mode === 'headline' ? 'Überschrift' : 'Volltext'} angezeigt`);
        }
    }

    function moveJoke(id, direction) {
        const jokesToShow = getJokesToShow();
        const currentIndex = jokesToShow.findIndex(j => j.id === id);
        if (currentIndex === -1) return;

        const newIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
        if (newIndex < 0 || newIndex >= jokesToShow.length) return;

        if (currentGroup === 'all') {
            // In Hauptliste verschieben
            const jokeIndex = jokes.findIndex(j => j.id === id);
            const targetJoke = jokesToShow[newIndex];
            const targetIndex = jokes.findIndex(j => j.id === targetJoke.id);

            const [movedJoke] = jokes.splice(jokeIndex, 1);
            jokes.splice(targetIndex, 0, movedJoke);
        } else {
            // In Gruppe verschieben
            const group = groups[currentGroup];
            if (group) {
                const [movedJokeId] = group.jokes.splice(currentIndex, 1);
                group.jokes.splice(newIndex, 0, movedJokeId);
            }
        }

        debouncedSave();
        renderJokes();

        setTimeout(() => {
            const element = document.querySelector(`.joke-item[data-id="${id}"] .drag-handle`);
            if (element) {
                element.focus();
            }
        }, 100);

        announceToScreenReader(`Witz nach ${direction === 'up' ? 'oben' : 'unten'} verschoben`);
    }

    function startEdit(id, field) {
        const joke = jokes.find(j => j.id === id);
        if (!joke) return;

        const element = document.querySelector(`.joke-item[data-id="${id}"] .joke-text`);
        const currentValue = joke[field];

        if (field === 'headline') {
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'joke-edit-input';
            input.value = currentValue;
            input.setAttribute('aria-label', 'Überschrift bearbeiten');

            element.replaceWith(input);
            input.focus();
            input.select();

            const save = () => {
                joke.headline = input.value.trim() || 'Neuer Witz';
                debouncedSave();
                renderJokes();
                announceToScreenReader('Überschrift gespeichert');
            };

            const cancel = () => {
                renderJokes();
            };

            input.addEventListener('blur', save);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    save();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancel();
                }
            });
        } else {
            const textarea = document.createElement('textarea');
            textarea.className = 'joke-edit-textarea';
            textarea.value = currentValue;
            textarea.setAttribute('aria-label', 'Volltext bearbeiten');

            element.replaceWith(textarea);
            textarea.focus();
            textarea.select();

            const save = () => {
                joke.fullText = textarea.value.trim() || 'Hier steht der Witz...';
                debouncedSave();
                renderJokes();
                announceToScreenReader('Volltext gespeichert');
            };

            const cancel = () => {
                renderJokes();
            };

            textarea.addEventListener('blur', save);
            textarea.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    cancel();
                }
                if (e.key === 'Enter' && e.ctrlKey) {
                    e.preventDefault();
                    save();
                }
            });
        }
    }

    // Auswahl-Management
    function toggleJokeSelection(id) {
        if (selectedJokes.has(id)) {
            selectedJokes.delete(id);
        } else {
            selectedJokes.add(id);
        }
        updateSelectionUI();
        renderJokes();
    }

    function clearSelection() {
        selectedJokes.clear();
        updateSelectionUI();
        renderJokes();
    }

    function updateSelectionUI() {
        const selectionActions = document.getElementById('selection-actions');
        const selectionInfo = document.getElementById('selection-info');
        const count = selectedJokes.size;

        if (count > 0) {
            selectionActions.classList.add('active');
            selectionInfo.textContent = `${count} Witz${count > 1 ? 'e' : ''} ausgewählt`;
        } else {
            selectionActions.classList.remove('active');
        }
    }

    function addSelectedToGroup() {
        const targetGroupId = document.getElementById('target-group-select').value;
        if (!targetGroupId) {
            alert('Bitte eine Zielgruppe auswählen!');
            return;
        }

        const group = groups[targetGroupId];
        if (!group) return;

        let addedCount = 0;
        selectedJokes.forEach(jokeId => {
            if (!group.jokes.includes(jokeId)) {
                group.jokes.push(jokeId);
                addedCount++;
            }
        });

        if (addedCount > 0) {
            debouncedSave();
            renderGroups();
            renderJokes();
            announceToScreenReader(`${addedCount} Witze zu "${group.name}" hinzugefügt`);
        } else {
            announceToScreenReader('Alle ausgewählten Witze sind bereits in der Gruppe');
        }

        clearSelection();
    }

    function removeSelectedFromGroup() {
        if (currentGroup === 'all') return;

        const group = groups[currentGroup];
        if (!group) return;

        let removedCount = 0;
        selectedJokes.forEach(jokeId => {
            const index = group.jokes.indexOf(jokeId);
            if (index > -1) {
                group.jokes.splice(index, 1);
                removedCount++;
            }
        });

        if (removedCount > 0) {
            debouncedSave();
            renderGroups();
            renderJokes();
            announceToScreenReader(`${removedCount} Witze aus "${group.name}" entfernt`);
        }

        clearSelection();
    }

    // Rendering
    function getJokesToShow() {
        let jokesToShow;

        if (currentGroup === 'all') {
            jokesToShow = jokes;
        } else {
            const group = groups[currentGroup];
            if (!group) return [];
            jokesToShow = group.jokes.map(id => jokes.find(j => j.id === id)).filter(Boolean);
        }

        if (searchTerm) {
            const term = searchTerm.toLowerCase();
            jokesToShow = jokesToShow.filter(joke =>
                joke.headline.toLowerCase().includes(term) ||
                joke.fullText.toLowerCase().includes(term)
            );
        }

        return jokesToShow;
    }

    function getJokeGroups(jokeId) {
        return Object.entries(groups).filter(([groupId, group]) =>
            group.jokes.includes(jokeId)
        ).map(([groupId, group]) => ({ id: groupId, name: group.name }));
    }

    function renderJokes() {
        const jokeList = document.getElementById('joke-list');
        const emptyState = document.getElementById('empty-state');
        const jokesToShow = getJokesToShow();

        if (jokesToShow.length === 0) {
            jokeList.innerHTML = '';
            emptyState.style.display = 'block';

            const emptyMessage = document.getElementById('empty-message');
            if (currentGroup === 'all') {
                if (jokes.length === 0) {
                    emptyMessage.textContent = 'Füge deinen ersten Witz hinzu!';
                } else {
                    emptyMessage.textContent = 'Keine Witze entsprechen deiner Suche.';
                }
            } else {
                const groupName = groups[currentGroup]?.name || 'diese Gruppe';
                emptyMessage.textContent = `Keine Witze in "${groupName}". Wähle Witze aus und füge sie zur Gruppe hinzu.`;
            }
            return;
        }

        emptyState.style.display = 'none';

        jokeList.innerHTML = jokesToShow.map((joke, index) => {
            const jokeGroups = getJokeGroups(joke.id);
            const isInCurrentGroup = currentGroup === 'all' || groups[currentGroup]?.jokes.includes(joke.id);
            const isSelected = selectedJokes.has(joke.id);

            return `
                <li class="joke-item ${isInCurrentGroup ? 'in-group' : ''} ${isSelected ? 'selected' : ''}"
                    data-id="${joke.id}" draggable="true" role="listitem">
                    <div class="joke-content">
                        <div class="joke-checkbox">
                            <input
                                type="checkbox"
                                ${isSelected ? 'checked' : ''}
                                onchange="toggleJokeSelection('${joke.id}')"
                                aria-label="Witz auswählen"
                            >
                        </div>

                        <div
                            class="drag-handle"
                            tabindex="0"
                            aria-label="Witz verschieben. Drag & Drop oder Pfeiltasten verwenden"
                            onkeydown="handleDragKeydown(event, '${joke.id}')"
                        >
                            ⋮⋮
                        </div>

                        <div class="joke-main">
                            <div
                                class="joke-text ${joke.mode === 'headline' ? 'joke-headline' : 'joke-fulltext'}"
                                onclick="startEdit('${joke.id}', '${joke.mode === 'headline' ? 'headline' : 'fullText'}')"
                                tabindex="0"
                                role="button"
                                aria-label="${joke.mode === 'headline' ? 'Überschrift' : 'Volltext'} bearbeiten"
                                onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();startEdit('${joke.id}', '${joke.mode === 'headline' ? 'headline' : 'fullText'}')}"
                            >
                                ${escapeHtml(joke.mode === 'headline' ? joke.headline : joke.fullText)}
                            </div>

                            <div class="joke-controls">
                                <div class="joke-groups-info">
                                    ${jokeGroups.length > 0 ? `
                                        <div class="group-tags">
                                            ${jokeGroups.map(group => `
                                                <span class="group-tag ${group.id === currentGroup ? 'current' : ''}">${escapeHtml(group.name)}</span>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>

                                <div class="mode-toggle">
                                    <span>Überschrift</span>
                                    <button
                                        class="toggle-switch ${joke.mode === 'full' ? 'active' : ''}"
                                        onclick="toggleJokeMode('${joke.id}')"
                                        aria-label="Anzeigemodus umschalten"
                                        aria-pressed="${joke.mode === 'full'}"
                                    ></button>
                                    <span>Volltext</span>
                                </div>

                                <div style="display: flex; gap: 5px;">
                                    <button
                                        class="btn btn-secondary btn-small"
                                        onclick="moveJoke('${joke.id}', 'up')"
                                        ${index === 0 ? 'disabled' : ''}
                                        aria-label="Witz nach oben verschieben"
                                    >
                                        ↑
                                    </button>
                                    <button
                                        class="btn btn-secondary btn-small"
                                        onclick="moveJoke('${joke.id}', 'down')"
                                        ${index === jokesToShow.length - 1 ? 'disabled' : ''}
                                        aria-label="Witz nach unten verschieben"
                                    >
                                        ↓
                                    </button>
                                </div>

                                <button
                                    class="btn btn-danger btn-small"
                                    onclick="deleteJoke('${joke.id}')"
                                    aria-label="Witz löschen"
                                >
                                    🗑️ Löschen
                                </button>
                            </div>
                        </div>
                    </div>
                </li>
            `;
        }).join('');
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function handleDragKeydown(event, jokeId) {
        if (event.key === 'ArrowUp') {
            event.preventDefault();
            moveJoke(jokeId, 'up');
        } else if (event.key === 'ArrowDown') {
            event.preventDefault();
            moveJoke(jokeId, 'down');
        }
    }

    // Drag & Drop
    function setupDragAndDrop() {
        const jokeList = document.getElementById('joke-list');

        jokeList.addEventListener('dragstart', (e) => {
            const jokeItem = e.target.closest('.joke-item');
            if (!jokeItem) return;

            draggedElement = jokeItem;
            jokeItem.classList.add('dragging');

            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', jokeItem.dataset.id);

            if (!dragPlaceholder) {
                dragPlaceholder = document.createElement('div');
                dragPlaceholder.className = 'drag-placeholder';
            }
        });

        jokeList.addEventListener('dragend', (e) => {
            if (draggedElement) {
                draggedElement.classList.remove('dragging');
                draggedElement = null;
            }

            if (dragPlaceholder && dragPlaceholder.parentNode) {
                dragPlaceholder.remove();
                dragPlaceholder = null;
            }
        });

        jokeList.addEventListener('dragover', (e) => {
            e.preventDefault();
            if (!draggedElement) return;

            const afterElement = getDragAfterElement(jokeList, e.clientY);

            if (!dragPlaceholder) {
                dragPlaceholder = document.createElement('div');
                dragPlaceholder.className = 'drag-placeholder active';
            }

            if (afterElement == null) {
                jokeList.appendChild(dragPlaceholder);
            } else {
                jokeList.insertBefore(dragPlaceholder, afterElement);
            }
        });

        jokeList.addEventListener('drop', (e) => {
            e.preventDefault();
            if (!draggedElement || !dragPlaceholder) return;

            const draggedId = draggedElement.dataset.id;
            const jokesToShow = getJokesToShow();
            const draggedIndex = jokesToShow.findIndex(j => j.id === draggedId);

            const placeholderIndex = Array.from(jokeList.children).indexOf(dragPlaceholder);
            let newIndex = 0;
            for (let i = 0; i < placeholderIndex; i++) {
                if (jokeList.children[i].classList.contains('joke-item') &&
                    !jokeList.children[i].classList.contains('dragging')) {
                    newIndex++;
                }
            }

            if (newIndex !== draggedIndex) {
                if (currentGroup === 'all') {
                    const jokeIndex = jokes.findIndex(j => j.id === draggedId);
                    const targetJoke = jokesToShow[newIndex];
                    const targetIndex = jokes.findIndex(j => j.id === targetJoke?.id);

                    if (targetIndex !== -1) {
                        const [movedJoke] = jokes.splice(jokeIndex, 1);
                        jokes.splice(targetIndex, 0, movedJoke);
                    }
                } else {
                    const group = groups[currentGroup];
                    if (group) {
                        const [movedJokeId] = group.jokes.splice(draggedIndex, 1);
                        group.jokes.splice(newIndex, 0, movedJokeId);
                    }
                }

                debouncedSave();
                announceToScreenReader('Witz-Reihenfolge geändert durch Drag & Drop');
            }

            renderJokes();
        });
    }

    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.joke-item:not(.dragging)')];

        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;

            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // Import/Export
    function exportData() {
        const data = {
            jokes: jokes,
            groups: groups,
            exported: new Date().toISOString(),
            version: '2.0'
        };

        const dataStr = JSON.stringify(data, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);

        const link = document.createElement('a');
        link.href = url;
        link.download = `witze-komplett-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        announceToScreenReader('Komplette Daten exportiert');
    }

    function showImportSection() {
        document.getElementById('import-section').classList.remove('hidden');
        document.getElementById('import-textarea').focus();
    }

    function hideImportSection() {
        document.getElementById('import-section').classList.add('hidden');
        document.getElementById('import-textarea').value = '';
    }

    function executeImport() {
        const jsonData = document.getElementById('import-textarea').value.trim();
        if (!jsonData) return;

        try {
            const data = JSON.parse(jsonData);

            // Backwards compatibility - alte Struktur unterstützen
            if (Array.isArray(data)) {
                // Alte Struktur: nur Witze-Array
                importJokesOnly(data);
                return;
            }

            // Neue Struktur mit Gruppen
            if (!data.jokes || !Array.isArray(data.jokes)) {
                throw new Error('Ungültiges Format: "jokes" Array fehlt');
            }

            const validJokes = data.jokes.filter(joke =>
                joke &&
                typeof joke === 'object' &&
                typeof joke.headline === 'string' &&
                typeof joke.fullText === 'string'
            ).map(joke => ({
                id: joke.id || `w${nextId++}`,
                headline: joke.headline,
                fullText: joke.fullText,
                mode: joke.mode === 'full' ? 'full' : 'headline'
            }));

            const validGroups = {};
            if (data.groups && typeof data.groups === 'object') {
                Object.entries(data.groups).forEach(([groupId, group]) => {
                    if (group && typeof group.name === 'string' && Array.isArray(group.jokes)) {
                        validGroups[groupId] = {
                            name: group.name,
                            jokes: group.jokes.filter(jokeId =>
                                validJokes.some(j => j.id === jokeId)
                            ),
                            created: group.created || new Date().toISOString()
                        };
                    }
                });
            }

            const totalItems = validJokes.length + Object.keys(validGroups).length;
            if (totalItems === 0) {
                throw new Error('Keine gültigen Daten gefunden');
            }

            const confirmMessage = `Import bestätigen:\n- ${validJokes.length} Witze\n- ${Object.keys(validGroups).length} Gruppen\n\nDies ersetzt alle aktuellen Daten!`;

            if (confirm(confirmMessage)) {
                jokes = validJokes;
                groups = validGroups;

                const maxId = jokes.reduce((max, joke) => {
                    const num = parseInt(joke.id.replace(/\D/g, '')) || 0;
                    return Math.max(max, num);
                }, 0);
                nextId = maxId + 1;

                currentGroup = 'all';
                clearSelection();
                debouncedSave();
                renderGroups();
                renderJokes();
                updateTargetGroupSelect();
                selectGroup('all');
                hideImportSection();
                announceToScreenReader(`${validJokes.length} Witze und ${Object.keys(validGroups).length} Gruppen importiert`);
            }
        } catch (e) {
            alert('Fehler beim Import: ' + e.message);
        }
    }

    function importJokesOnly(jokeArray) {
        const validJokes = jokeArray.filter(joke =>
            joke &&
            typeof joke === 'object' &&
            typeof joke.headline === 'string' &&
            typeof joke.fullText === 'string'
        ).map(joke => ({
            id: joke.id || `w${nextId++}`,
            headline: joke.headline,
            fullText: joke.fullText,
            mode: joke.mode === 'full' ? 'full' : 'headline'
        }));

        if (validJokes.length === 0) {
            throw new Error('Keine gültigen Witze gefunden');
        }

        if (confirm(`${validJokes.length} Witze importieren?\nDies ersetzt die aktuelle Witze-Liste, Gruppen bleiben erhalten.`)) {
            jokes = validJokes;

            const maxId = jokes.reduce((max, joke) => {
                const num = parseInt(joke.id.replace(/\D/g, '')) || 0;
                return Math.max(max, num);
            }, 0);
            nextId = maxId + 1;

            // Gruppen bereinigen - entferne nicht-existente Witze
            Object.values(groups).forEach(group => {
                group.jokes = group.jokes.filter(jokeId =>
                    jokes.some(j => j.id === jokeId)
                );
            });

            debouncedSave();
            renderGroups();
            renderJokes();
            hideImportSection();
            announceToScreenReader(`${validJokes.length} Witze importiert`);
        }
    }

    // Event Listeners & Initialization
    function setupEventListeners() {
        const searchInput = document.getElementById('search-input');
        searchInput.addEventListener('input', (e) => {
            searchTerm = e.target.value.trim();
            renderJokes();
        });

        const newGroupInput = document.getElementById('new-group-input');
        newGroupInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                createGroup();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                exportData();
            }

            if (e.key === 'Escape') {
                if (!document.getElementById('import-section').classList.contains('hidden')) {
                    hideImportSection();
                } else {
                    clearSelection();
                }
            }
        });

        setupDragAndDrop();
    }

    function init() {
        loadData();
        renderGroups();
        renderJokes();
        updateTargetGroupSelect();
        setupEventListeners();

        console.log('🎭 Erweiterte Witze-App mit Gruppenverwaltung geladen!');
        console.log('Features:');
        console.log('- Gruppenverwaltung mit flexibler Zuordnung');
        console.log('- Mehrfach-Auswahl von Witze');
        console.log('- Drag & Drop innerhalb von Gruppen');
        console.log('- Import/Export mit Gruppenerhaltung');
        console.log('- Live-Suche über alle Bereiche');
        console.log('- Vollständige Barrierefreiheit');
    }

    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>